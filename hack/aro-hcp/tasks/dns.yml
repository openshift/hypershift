version: '3'

# This file handles External DNS setup

vars:
  EXTERNAL_DNS_SP_NAME: '{{.PREFIX}}-ExternalDnsServicePrincipal'

tasks:
  # === DNS ZONE ===

  create-zone:
    status:
      - az network dns zone show --resource-group {{.PERSISTENT_RG_NAME}} --name {{.MGMT_DNS_ZONE_NAME}} 2>/dev/null
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Creating DNS Zone"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - az network dns zone create --resource-group {{.PERSISTENT_RG_NAME}} --name {{.MGMT_DNS_ZONE_NAME}}
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,DNS Zone
          Name,{{.MGMT_DNS_ZONE_NAME}}
          Resource Group,{{.PERSISTENT_RG_NAME}}
          Status,✓ Created" | gum table --print --border rounded
        silent: true

  add-ns-record:
    internal: true
    requires:
      vars: [NS_NAME]
    cmds:
      - az network dns record-set ns add-record --resource-group {{.PERSISTENT_RG_NAME}} --zone-name {{.PARENT_DNS_ZONE}} --record-set-name {{.PREFIX}} --nsdname {{.NS_NAME}}

  delegate-zone:
    vars:
      NAME_SERVERS:
        sh: 'az network dns zone show --resource-group {{.PERSISTENT_RG_NAME}} --name {{.MGMT_DNS_ZONE_NAME}} --query nameServers -o tsv | tr "\n" " "'
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Delegating DNS Zone"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      # Delete existing record set if any
      - cmd: az network dns record-set ns delete --resource-group {{.PERSISTENT_RG_NAME}} --zone-name {{.PARENT_DNS_ZONE}} --name {{.PREFIX}} -y
        ignore_error: true
      # Add name servers to parent zone
      - for: { var: NAME_SERVERS }
        task: add-ns-record
        vars:
          NS_NAME: "{{.ITEM}}"
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,DNS Zone Delegation
          Zone,{{.MGMT_DNS_ZONE_NAME}}
          Parent Zone,{{.PARENT_DNS_ZONE}}
          NS Record,{{.PREFIX}}
          Status,✓ Delegated" | gum table --print --border rounded
        silent: true

  # === SERVICE PRINCIPAL ===

  create-sp:
    status:
      - test -f {{.EXTERNAL_DNS_CREDS_FILE}}
    vars:
      DNS_ZONE_ID:
        sh: 'az network dns zone show --name {{.MGMT_DNS_ZONE_NAME}} --resource-group {{.PERSISTENT_RG_NAME}} --query "id" --output tsv 2>/dev/null || echo ""'
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Creating External DNS Service Principal"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - |
        DNS_SP=$(az ad sp create-for-rbac --name {{.EXTERNAL_DNS_SP_NAME}})
        EXTERNAL_DNS_SP_APP_ID=$(echo "$DNS_SP" | jq -r '.appId')
        EXTERNAL_DNS_SP_PASSWORD=$(echo "$DNS_SP" | jq -r '.password')

        az role assignment create \
          --role "Reader" \
          --assignee "${EXTERNAL_DNS_SP_APP_ID}" \
          --scope "{{.DNS_ZONE_ID}}"

        az role assignment create \
          --role "Contributor" \
          --assignee "${EXTERNAL_DNS_SP_APP_ID}" \
          --scope "{{.DNS_ZONE_ID}}"

        cat > {{.EXTERNAL_DNS_CREDS_FILE}} <<EOF
        {
          "tenantId": "$(az account show --query tenantId -o tsv)",
          "subscriptionId": "$(az account show --query id -o tsv)",
          "resourceGroup": "{{.PERSISTENT_RG_NAME}}",
          "aadClientId": "$EXTERNAL_DNS_SP_APP_ID",
          "aadClientSecret": "$EXTERNAL_DNS_SP_PASSWORD"
        }
        EOF
        chmod 600 {{.EXTERNAL_DNS_CREDS_FILE}}
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,External DNS SP
          Name,{{.EXTERNAL_DNS_SP_NAME}}
          Roles,Reader + Contributor on Zone
          Credentials,{{.EXTERNAL_DNS_CREDS_FILE}}
          Status,✓ Created" | gum table --print --border rounded
        silent: true

  # === KUBERNETES SECRET ===

  create-secret:
    preconditions:
      - sh: test -f {{.EXTERNAL_DNS_CREDS_FILE}}
        msg: "External DNS credentials file not found at {{.EXTERNAL_DNS_CREDS_FILE}}"
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Creating External DNS Secret"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - kubectl delete secret azure-config-file --namespace default --ignore-not-found
      - kubectl create secret generic azure-config-file --namespace default --from-file={{.EXTERNAL_DNS_CREDS_FILE}}
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,External DNS Secret
          Secret Name,azure-config-file
          Namespace,default
          Status,✓ Created" | gum table --print --border rounded
        silent: true

  # === ORCHESTRATION ===

  setup:
    cmds:
      - task: create-zone
      - task: delegate-zone
      - task: create-sp
      - task: create-secret
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,External DNS Setup
          Zone,{{.MGMT_DNS_ZONE_NAME}}
          Parent Zone,{{.PARENT_DNS_ZONE}}
          SP,{{.EXTERNAL_DNS_SP_NAME}}
          Secret,azure-config-file
          Status,✓ Complete" | gum table --print --border rounded
        silent: true

  # === CLEANUP ===

  delete-secret:
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Deleting External DNS Secret"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - kubectl delete secret azure-config-file --namespace default --ignore-not-found
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,Delete DNS Secret
          Secret Name,azure-config-file
          Status,✓ Deleted" | gum table --print --border rounded
        silent: true

  delete-sp:
    vars:
      APP_ID:
        sh: 'az ad sp list --display-name {{.EXTERNAL_DNS_SP_NAME}} --query "[0].appId" -o tsv 2>/dev/null || echo ""'
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Deleting External DNS Service Principal"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - cmd: |
          if [ -n "{{.APP_ID}}" ]; then
            az ad app delete --id {{.APP_ID}}
          fi
        ignore_error: true
      - rm -f {{.EXTERNAL_DNS_CREDS_FILE}}
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,Delete DNS SP
          Name,{{.EXTERNAL_DNS_SP_NAME}}
          Status,✓ Deleted" | gum table --print --border rounded
        silent: true

  delete-zone:
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Deleting DNS Zone"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - cmd: az network dns record-set ns delete --resource-group {{.PERSISTENT_RG_NAME}} --zone-name {{.PARENT_DNS_ZONE}} --name {{.PREFIX}} -y
        ignore_error: true
      - cmd: az network dns zone delete --resource-group {{.PERSISTENT_RG_NAME}} --name {{.MGMT_DNS_ZONE_NAME}} --yes
        ignore_error: true
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,Delete DNS Zone
          Zone,{{.MGMT_DNS_ZONE_NAME}}
          Status,✓ Deleted" | gum table --print --border rounded
        silent: true

  delete:
    cmds:
      - task: delete-secret
      - task: delete-sp
      - task: delete-zone
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,External DNS Cleanup
          Zone,{{.MGMT_DNS_ZONE_NAME}}
          NS Record,{{.PREFIX}} (from {{.PARENT_DNS_ZONE}})
          SP,{{.EXTERNAL_DNS_SP_NAME}}
          Secret,azure-config-file
          Status,✓ Complete" | gum table --print --border rounded
        silent: true

  # === STATUS ===

  show:
    vars:
      ZONE_EXISTS:
        sh: 'az network dns zone show --resource-group {{.PERSISTENT_RG_NAME}} --name {{.MGMT_DNS_ZONE_NAME}} -o none 2>/dev/null && echo "✓ Exists" || echo "✗ Not found"'
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "DNS Zone Status"
        silent: true
      - cmd: az network dns zone show --resource-group {{.PERSISTENT_RG_NAME}} --name {{.MGMT_DNS_ZONE_NAME}} -o table
        ignore_error: true
