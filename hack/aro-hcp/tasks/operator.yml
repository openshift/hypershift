version: '3'

# This file handles HyperShift operator installation on AKS (ARO-HCP mode)

tasks:
  # === CRD INSTALLATION ===

  apply-crds:
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Applying Missing CRDs"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
      - kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
      - kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
      - kubectl apply -f https://raw.githubusercontent.com/openshift/api/6bababe9164ea6c78274fd79c94a3f951f8d5ab2/route/v1/zz_generated.crd-manifests/routes.crd.yaml
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,Apply CRDs
          CRDs,ServiceMonitors PrometheusRules PodMonitors Routes
          Status,✓ Applied" | gum table --print --border rounded
        silent: true

  # === OPERATOR INSTALLATION ===

  install:
    desc: Install HyperShift operator (ARO-HCP mode)
    status:
      - kubectl get deployment operator -n hypershift < /dev/null 2>/dev/null
    vars:
      KV_CLIENT_ID:
        sh: 'az aks show -n {{.AKS_CLUSTER_NAME}} -g {{.AKS_RG}} --query "addonProfiles.azureKeyvaultSecretsProvider.identity.clientId" -o tsv'
      HYPERSHIFT_CMD:
        sh: 'test -n "{{.HYPERSHIFT_BINARY_PATH}}" && echo "{{.HYPERSHIFT_BINARY_PATH}}/hypershift" || echo "hypershift"'
    preconditions:
      - sh: test -f {{.PULL_SECRET}}
        msg: "Pull secret not found at {{.PULL_SECRET}}"
      - sh: test -f {{.EXTERNAL_DNS_CREDS_FILE}}
        msg: "External DNS credentials not found at {{.EXTERNAL_DNS_CREDS_FILE}}"
    cmds:
      - task: apply-crds
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Installing HyperShift Operator"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - |
        IMAGE_FLAG=""
        if [ -n "{{.HYPERSHIFT_IMAGE}}" ]; then
          IMAGE_FLAG="--hypershift-image {{.HYPERSHIFT_IMAGE}}"
        fi

        {{.HYPERSHIFT_CMD}} install \
          --enable-conversion-webhook=false \
          --external-dns-provider=azure \
          --external-dns-credentials {{.EXTERNAL_DNS_CREDS_FILE}} \
          --pull-secret {{.PULL_SECRET}} \
          --external-dns-domain-filter {{.MGMT_DNS_ZONE_NAME}} \
          --managed-service ARO-HCP \
          --aro-hcp-key-vault-users-client-id "{{.KV_CLIENT_ID}}" \
          --limit-crd-install Azure \
          --tech-preview-no-upgrade \
          $IMAGE_FLAG
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,Install HyperShift Operator
          Namespace,hypershift
          Mode,ARO-HCP
          DNS Zone,{{.MGMT_DNS_ZONE_NAME}}
          Key Vault Client,{{.KV_CLIENT_ID}}
          CRD Platform,Azure
          Status,✓ Installed" | gum table --print --border rounded
        silent: true

  # === VERIFICATION ===

  verify:
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "HyperShift Operator Status"
        silent: true
      - kubectl get pods -n hypershift
      - kubectl get deployment operator -n hypershift
      - kubectl get deployment external-dns -n hypershift 2>/dev/null || gum format "○ External DNS not deployed"

  wait:
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Waiting for Operator"
        silent: true
      - cmd: gum style --faint "Output:"
        silent: true
      - kubectl wait --for=condition=available deployment/operator -n hypershift --timeout=300s
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,Wait for Operator
          Deployment,operator
          Namespace,hypershift
          Status,✓ Ready" | gum table --print --border rounded
        silent: true

  logs:
    desc: Show operator logs
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Operator Logs"
        silent: true
      - kubectl logs -n hypershift deployment/operator --tail=50

  # === UNINSTALLATION ===

  uninstall:
    desc: Uninstall HyperShift operator
    vars:
      HC_COUNT:
        sh: 'kubectl get hostedclusters --all-namespaces -o name < /dev/null 2>/dev/null | wc -l | tr -d " "'
      KV_CLIENT_ID:
        sh: 'az aks show -n {{.AKS_CLUSTER_NAME}} -g {{.AKS_RG}} --query "addonProfiles.azureKeyvaultSecretsProvider.identity.clientId" -o tsv 2>/dev/null || echo ""'
      HYPERSHIFT_CMD:
        sh: 'test -n "{{.HYPERSHIFT_BINARY_PATH}}" && echo "{{.HYPERSHIFT_BINARY_PATH}}/hypershift" || echo "hypershift"'
    cmds:
      - cmd: gum style --border normal --padding "0 1" --border-foreground 212 "Uninstalling HyperShift Operator"
        silent: true
      - |
        if [ "{{.HC_COUNT}}" -gt 0 ]; then
          gum format "✗ {{.HC_COUNT}} HostedCluster(s) exist. Delete them first with 'task cluster:destroy'"
          kubectl get hostedclusters --all-namespaces
          exit 1
        fi
      - cmd: |
          IMAGE_FLAG=""
          if [ -n "{{.HYPERSHIFT_IMAGE}}" ]; then
            IMAGE_FLAG="--hypershift-image {{.HYPERSHIFT_IMAGE}}"
          fi

          {{.HYPERSHIFT_CMD}} install render \
            --enable-conversion-webhook=false \
            --external-dns-provider=azure \
            --external-dns-credentials {{.EXTERNAL_DNS_CREDS_FILE}} \
            --pull-secret {{.PULL_SECRET}} \
            --external-dns-domain-filter {{.MGMT_DNS_ZONE_NAME}} \
            --managed-service ARO-HCP \
            --aro-hcp-key-vault-users-client-id "{{.KV_CLIENT_ID}}" \
            --limit-crd-install Azure \
            --tech-preview-no-upgrade \
            $IMAGE_FLAG | kubectl delete --ignore-not-found -f -
        ignore_error: true
      - cmd: gum style --border normal --padding "0 1" --border-foreground 10 "Task Summary"
        silent: true
      - cmd: |
          echo "Property,Value
          Task,Uninstall Operator
          Namespace,hypershift
          CRDs,Preserved (to prevent data loss)
          Status,✓ Uninstalled" | gum table --print --border rounded
        silent: true
