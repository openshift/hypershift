ignition:
  version: 3.2.0
storage:
  files:
  - contents:
      source: data:text/plain;charset=utf-8;base64,IyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLXgKaXAgYWRkciBhZGQgY2x1c3Rlci5pbnRlcm5hbC5leGFtcGxlLmNvbS8zMiBicmQgY2x1c3Rlci5pbnRlcm5hbC5leGFtcGxlLmNvbSBzY29wZSBob3N0IGRldiBsbwppcCByb3V0ZSBhZGQgY2x1c3Rlci5pbnRlcm5hbC5leGFtcGxlLmNvbS8zMiBkZXYgbG8gc2NvcGUgbGluayBzcmMgY2x1c3Rlci5pbnRlcm5hbC5leGFtcGxlLmNvbQo=
    mode: 493
    overwrite: true
    path: /usr/local/bin/setup-apiserver-ip.sh
  - contents:
      source: data:text/plain;charset=utf-8;base64,IyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLXgKaXAgYWRkciBkZWxldGUgY2x1c3Rlci5pbnRlcm5hbC5leGFtcGxlLmNvbS8zMiBkZXYgbG8KaXAgcm91dGUgZGVsIGNsdXN0ZXIuaW50ZXJuYWwuZXhhbXBsZS5jb20vMzIgZGV2IGxvIHNjb3BlIGxpbmsgc3JjIGNsdXN0ZXIuaW50ZXJuYWwuZXhhbXBsZS5jb20K
    mode: 493
    overwrite: true
    path: /usr/local/bin/teardown-apiserver-ip.sh
  - contents:
      source: data:text/plain;charset=utf-8;base64,Z2xvYmFsCiAgbWF4Y29ubiA3MDAwCiAgbG9nIHN0ZG91dCBsb2NhbDAKICBsb2cgc3Rkb3V0IGxvY2FsMSBub3RpY2UKCmRlZmF1bHRzCiAgbW9kZSB0Y3AKICB0aW1lb3V0IGNsaWVudCAxMG0KICB0aW1lb3V0IHNlcnZlciAxMG0KICB0aW1lb3V0IGNvbm5lY3QgMTBzCiAgdGltZW91dCBjbGllbnQtZmluIDVzCiAgdGltZW91dCBzZXJ2ZXItZmluIDVzCiAgdGltZW91dCBxdWV1ZSA1cwogIHJldHJpZXMgMwoKZnJvbnRlbmQgbG9jYWxfYXBpc2VydmVyCiAgYmluZCBjbHVzdGVyLmludGVybmFsLmV4YW1wbGUuY29tOjg0NDMKICBsb2cgZ2xvYmFsCiAgbW9kZSB0Y3AKICBvcHRpb24gdGNwbG9nCiAgZGVmYXVsdF9iYWNrZW5kIHJlbW90ZV9hcGlzZXJ2ZXIKCmJhY2tlbmQgcmVtb3RlX2FwaXNlcnZlcgogIG1vZGUgdGNwCiAgbG9nIGdsb2JhbAogIG9wdGlvbiBodHRwY2hrIEdFVCAvdmVyc2lvbgogIG9wdGlvbiBsb2ctaGVhbHRoLWNoZWNrcwogIGRlZmF1bHQtc2VydmVyIGludGVyIDEwcyBmYWxsIDMgcmlzZSAzCiAgc2VydmVyIGNvbnRyb2xwbGFuZSBjbHVzdGVyLmV4YW1wbGUuY29tOjQ0MyBzZW5kLXByb3h5LXYyIHNldC1wcm94eS12Mi10bHYtZm10KDB4MjApICVbc3RyKCJmYWtlQ2x1c3RlcklEIildCg==
    mode: 420
    overwrite: true
    path: /etc/kubernetes/apiserver-proxy-config/haproxy.cfg
  - contents:
      source: data:text/plain;charset=utf-8;base64,YXBpVmVyc2lvbjogdjEKa2luZDogUG9kCm1ldGFkYXRhOgogIGNyZWF0aW9uVGltZXN0YW1wOiBudWxsCiAgbGFiZWxzOgogICAgazhzLWFwcDoga3ViZS1hcGlzZXJ2ZXItcHJveHkKICBuYW1lOiBrdWJlLWFwaXNlcnZlci1wcm94eQogIG5hbWVzcGFjZToga3ViZS1zeXN0ZW0Kc3BlYzoKICBjb250YWluZXJzOgogIC0gY29tbWFuZDoKICAgIC0gaGFwcm94eQogICAgLSAtZgogICAgLSAvdXNyL2xvY2FsL2V0Yy9oYXByb3h5CiAgICBpbWFnZTogcXVheS5pby9yaF9lZV9icmNveC9oeXBlcnNoaWZ0OmhhcHJveHkyLjkuOS1tdWx0aQogICAgbGl2ZW5lc3NQcm9iZToKICAgICAgZmFpbHVyZVRocmVzaG9sZDogMwogICAgICBodHRwR2V0OgogICAgICAgIGhvc3Q6IGNsdXN0ZXIuaW50ZXJuYWwuZXhhbXBsZS5jb20KICAgICAgICBwYXRoOiAvdmVyc2lvbgogICAgICAgIHBvcnQ6IDg0NDMKICAgICAgICBzY2hlbWU6IEhUVFBTCiAgICAgIGluaXRpYWxEZWxheVNlY29uZHM6IDEyMAogICAgICBwZXJpb2RTZWNvbmRzOiAxMjAKICAgICAgc3VjY2Vzc1RocmVzaG9sZDogMQogICAgbmFtZTogaGFwcm94eQogICAgcG9ydHM6CiAgICAtIGNvbnRhaW5lclBvcnQ6IDg0NDMKICAgICAgaG9zdFBvcnQ6IDg0NDMKICAgICAgbmFtZTogYXBpc2VydmVyCiAgICAgIHByb3RvY29sOiBUQ1AKICAgIHJlc291cmNlczoKICAgICAgcmVxdWVzdHM6CiAgICAgICAgY3B1OiAxM20KICAgICAgICBtZW1vcnk6IDE2TWkKICAgIHNlY3VyaXR5Q29udGV4dDoKICAgICAgcnVuQXNVc2VyOiAxMDAxCiAgICB2b2x1bWVNb3VudHM6CiAgICAtIG1vdW50UGF0aDogL3Vzci9sb2NhbC9ldGMvaGFwcm94eQogICAgICBuYW1lOiBjb25maWcKICBob3N0TmV0d29yazogdHJ1ZQogIHByaW9yaXR5Q2xhc3NOYW1lOiBzeXN0ZW0tbm9kZS1jcml0aWNhbAogIHZvbHVtZXM6CiAgLSBob3N0UGF0aDoKICAgICAgcGF0aDogL2V0Yy9rdWJlcm5ldGVzL2FwaXNlcnZlci1wcm94eS1jb25maWcKICAgIG5hbWU6IGNvbmZpZwpzdGF0dXM6IHt9Cg==
    mode: 420
    overwrite: true
    path: /etc/kubernetes/manifests/kube-apiserver-proxy.yaml
systemd:
  units:
  - contents: |
      [Unit]
      Description=Sets up local IP to proxy API server requests
      Wants=network-online.target
      After=network-online.target

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/setup-apiserver-ip.sh
      ExecStop=/usr/local/bin/teardown-apiserver-ip.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
    enabled: true
    name: apiserver-ip.service
